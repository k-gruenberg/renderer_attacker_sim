<!DOCTYPE html>
<html>
	<head>
		<title>Exploit Console</title>
	</head>
	<body>

		<script>
			window.addEventListener("message", event => {
				if (event.data && event.data.type === "FROM_EXTENSION") {
					if (event.data.resp === "responseAttackerReadExtensionStorageLocal") {
						document.getElementById('ext-storage').textContent = JSON.stringify(event.data.payload, null, 4);
					} else if (event.data.resp === "responseAttackerSendMessage") {
						document.getElementById('ext-message-response').textContent = JSON.stringify(event.data.payload, null, 4);
					} else if (event.data.resp === "responseAttackerPortMessage") {
						document.getElementById("chat").value += "<- " + JSON.stringify(event.data.payload, null, 4) + "\n";
					} else if (event.data.resp === "responseAttackerPortDisconnect") {
						document.getElementById("chat").value += "Other side disconnected.\n";
					}
				}
			});

			function read_ext_storage() {
				window.postMessage({type: "FROM_PAGE", req: "attackerReadExtensionStorageLocal"});
			}

			function write_ext_storage() {
				try {
					let key = document.getElementById("key-tf").value;
					let value = JSON.parse(document.getElementById("value-tf").value);
					window.postMessage({type: "FROM_PAGE", req: "attackerWriteExtensionStorageLocal", key: key, value: value});
					document.getElementById("ext-storage-error").innerText = "";
				} catch (error) {
					document.getElementById("ext-storage-error").innerText = error;
				}
			}

			function send_ext_message() {
				try {
					let message = JSON.parse(document.getElementById("ext-message").value);
					let redirect = document.getElementById("redirect-checkbox").checked;
					let redirect_destination = document.getElementById("redirect-destination").value;

					if (redirect) {
						window.postMessage({
							type: "FROM_PAGE",
							req: "attackerRedirectAndSendMessageOnUnload",
							payload: message,
							redirect_destination: redirect_destination,
						});

						// // The same but redirecting and "unload" event registration happens here in
						// //   exploit_console.html instead of in the Content Script:
						// window.addEventListener("unload", (event) => {
						//     window.postMessage({type: "FROM_PAGE", req: "attackerSendMessage", payload: message});
						// });
						// window.location.href = redirect_destination;
					} else {
						window.postMessage({type: "FROM_PAGE", req: "attackerSendMessage", payload: message});
						document.getElementById("ext-message-error").innerText = "";
					}
				} catch (error) {
					document.getElementById("ext-message-error").innerText = error;
				}
			}

			function ext_connect() {
				document.getElementById("chat").value += "Connecting...\n";
				window.postMessage({type: "FROM_PAGE", req: "attackerOpenConnection"});
				document.getElementById("chat").value += "Connected.\n";
			}

			function ext_disconnect() {
				document.getElementById("chat").value += "Disconnecting...\n";
				window.postMessage({type: "FROM_PAGE", req: "attackerCloseConnection"});
				document.getElementById("chat").value += "Disconnected.\n";
			}

			function port_post_message() {
				let message = JSON.parse(document.getElementById("ext-message-port").value);
				document.getElementById("chat").value += ">> " + JSON.stringify(message) + "\n";
				window.postMessage({type: "FROM_PAGE", req: "attackerPostMessageOnPort", payload: message});
			}
		</script>

		<h1>Renderer Attacker Exploit Console</h1>

		<b>For this console to work, you need to append the content of <code>code_snippet.js</code>
		to the content script of the extension to test.</b>

		<br/><br/>

		<h2>Extension Storage (Local)</h2>
		<textarea readonly id="ext-storage" style="font-family: monospace;" rows="10" cols="100" placeholder="storage content will appear here"></textarea>
		<br/>
		<button type="button" onclick="read_ext_storage();">Read extension storage</button><br/>
		<input type="text" id="key-tf" size="30" style="font-family: monospace;" placeholder="key" />:
		<input type="text" id="value-tf" size="30" style="font-family: monospace;" placeholder="value JSON" />
		<button type="button" onclick="write_ext_storage();">Write extension storage</button>
		<span id="ext-storage-error" style="color:red"></span>

		<br/><br/>

		<h2>Extension Message</h2>
		<textarea id="ext-message" style="font-family: monospace;" rows="10" cols="70" placeholder="message JSON"></textarea>
		-----&gt;
		<textarea readonly id="ext-message-response" style="font-family: monospace;" rows="10" cols="70" placeholder="response JSON"></textarea>
		<br/>
		<button type="button" onclick="send_ext_message();">Send extension message</button>
		<span id="ext-message-error" style="color:red"></span>
		<input type="checkbox" id="redirect-checkbox" name="redirect-checkbox">
		<label for="redirect-checkbox"> Redirect to: </label>
		<input type="text" id="redirect-destination" size="60" style="font-family: monospace;" placeholder="redirect URL" />

		<br/><br/>

		<h2>Extension Communication</h2>
		<button type="button" onclick="ext_connect();">Connect</button>
		<button type="button" onclick="ext_disconnect();">Disconnect</button>
		<span id="connection-info"></span><br/>
		<textarea readonly id="chat" style="font-family: monospace;" rows="10" cols="100" placeholder="exchanged messages will appear here"></textarea><br/>
		<input type="text" id="ext-message-port" size="60" style="font-family: monospace;" placeholder="message JSON" />
		<button type="button" onclick="port_post_message();">Post message on port</button>

		<br/><br/>

	</body>
</html>
